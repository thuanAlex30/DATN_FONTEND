import React, { useState, useRef } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { Link, useNavigate } from 'react-router-dom';
import type { AppDispatch, RootState } from '../../../store';
import { updateAvatar, refreshUserProfile } from '../../../store/slices/authSlice';
import userService from '../../../services/userService';
import Toast from '../../../components/Toast';
import styles from './ChangeAvatar.module.css';

const ChangeAvatarPage: React.FC = () => {
  const dispatch = useDispatch<AppDispatch>();
  const navigate = useNavigate();
  const { user, loading } = useSelector((state: RootState) => state.auth);
  
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string>('');
  const [isDragOver, setIsDragOver] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  const [toast, setToast] = useState<{
    message: string;
    type: 'success' | 'error' | 'info';
    isVisible: boolean;
  }>({
    message: '',
    type: 'info',
    isVisible: false,
  });

  const handleFileSelect = (file: File) => {
    // Validate file type
    if (!file.type.startsWith('image/')) {
      setToast({
        message: 'Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá',
        type: 'error',
        isVisible: true,
      });
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      setToast({
        message: 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB',
        type: 'error',
        isVisible: true,
      });
      return;
    }

    console.log('üîç File selected:', file);
    console.log('üîç File details:', {
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified
    });
    setSelectedFile(file);
    
    // Create preview URL
    const url = URL.createObjectURL(file);
    setPreviewUrl(url);
    console.log('üîç Preview URL created:', url);
  };

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      handleFileSelect(file);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragOver(false);
    
    const file = e.dataTransfer.files[0];
    if (file) {
      handleFileSelect(file);
    }
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragOver(true);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragOver(false);
  };

  const handleRemoveImage = () => {
    setSelectedFile(null);
    setPreviewUrl('');
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedFile) {
      setToast({
        message: 'Vui l√≤ng ch·ªçn ·∫£nh ƒë·∫°i di·ªán',
        type: 'error',
        isVisible: true,
      });
      return;
    }

    try {
      console.log('üîç ChangeAvatarPage - selectedFile:', selectedFile);
      console.log('üîç ChangeAvatarPage - file details:', {
        name: selectedFile.name,
        size: selectedFile.size,
        type: selectedFile.type
      });
      
      // Upload avatar using userService
      const result = await userService.uploadAvatar(selectedFile);
      
      console.log('üîç ChangeAvatarPage - upload result:', result);
      console.log('üîç ChangeAvatarPage - result.avatar:', result.avatar);
      
      // Always refresh user profile from server to get latest data including avatar
      console.log('üîç ChangeAvatarPage - Refreshing profile from server...');
      await dispatch(refreshUserProfile()).unwrap();
      
      // Also update Redux state directly if avatar was returned
      if (result.avatar) {
        dispatch(updateAvatar(result.avatar));
        console.log('üîç ChangeAvatarPage - Redux updated with avatar:', result.avatar);
      }
      
      setToast({
        message: 'C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!',
        type: 'success',
        isVisible: true,
      });
      
      // Navigate back to profile after a short delay
      setTimeout(() => {
        navigate('/profile');
      }, 1500);
      
    } catch (error: any) {
      console.error('‚ùå ChangeAvatarPage - upload error:', error);
      setToast({
        message: error?.response?.data?.message || error?.message || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán',
        type: 'error',
        isVisible: true,
      });
    }
  };

  const handleCancel = () => {
    navigate('/profile');
  };

  const openFileDialog = () => {
    fileInputRef.current?.click();
  };

  if (!user) {
    return <div>Loading...</div>;
  }

  return (
    <div className={styles.changeAvatarContainer}>
      {/* Header */}
      <header className={styles.changeAvatarHeader}>
        <div className={styles.headerContent}>
          <div className={styles.headerLeft}>
            <Link to="/profile" className={styles.backButton}>
              <i className="fas fa-arrow-left"></i>
              <span>Quay l·∫°i</span>
            </Link>
            <h1 className={styles.headerTitle}>ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán</h1>
          </div>
          <div className={styles.headerRight}>
            <div className={styles.userInfo}>
              <span className={styles.userName}>{user.full_name}</span>
              <span className={styles.userRole}>{user.role?.role_name}</span>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className={styles.changeAvatarContent}>
        <div className={styles.changeAvatarCard}>
          <div className={styles.cardHeader}>
            <h2 className={styles.cardTitle}>
              <i className="fas fa-user-circle"></i>
              ·∫¢nh ƒë·∫°i di·ªán
            </h2>
            <p className={styles.cardDescription}>
              Ch·ªçn ·∫£nh ƒë·∫°i di·ªán m·ªõi cho t√†i kho·∫£n c·ªßa b·∫°n
            </p>
          </div>

          <form onSubmit={handleSubmit} className={styles.changeAvatarForm}>
            {/* Current Avatar */}
            <div className={styles.currentAvatarSection}>
              <h3 className={styles.sectionTitle}>·∫¢nh hi·ªán t·∫°i</h3>
              <div className={styles.currentAvatarContainer}>
                <img 
                  src={user.avatar || `https://via.placeholder.com/150/4F46E5/FFFFFF?text=${user.full_name?.charAt(0)}`}
                  alt="Current Avatar" 
                  className={styles.currentAvatar}
                />
              </div>
            </div>

            {/* New Avatar Upload */}
            <div className={styles.newAvatarSection}>
              <h3 className={styles.sectionTitle}>·∫¢nh m·ªõi</h3>
              
              <div 
                className={`${styles.uploadArea} ${isDragOver ? styles.dragOver : ''}`}
                onDrop={handleDrop}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onClick={openFileDialog}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleFileInputChange}
                  className={styles.fileInput}
                />
                
                {previewUrl ? (
                  <div className={styles.previewContainer}>
                    <img 
                      src={previewUrl} 
                      alt="Preview" 
                      className={styles.previewImage}
                    />
                    <button
                      type="button"
                      className={styles.removeButton}
                      onClick={(e) => {
                        e.stopPropagation();
                        handleRemoveImage();
                      }}
                    >
                      <i className="fas fa-times"></i>
                    </button>
                  </div>
                ) : (
                  <div className={styles.uploadPlaceholder}>
                    <i className="fas fa-cloud-upload-alt"></i>
                    <p className={styles.uploadText}>
                      K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn
                    </p>
                    <p className={styles.uploadHint}>
                      H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Avatar Guidelines */}
            <div className={styles.guidelinesSection}>
              <h4 className={styles.guidelinesTitle}>H∆∞·ªõng d·∫´n ·∫£nh ƒë·∫°i di·ªán:</h4>
              <ul className={styles.guidelinesList}>
                <li className={styles.guideline}>
                  <i className="fas fa-check"></i>
                  K√≠ch th∆∞·ªõc t·ªëi thi·ªÉu: 100x100px
                </li>
                <li className={styles.guideline}>
                  <i className="fas fa-check"></i>
                  T·ª∑ l·ªá khuy·∫øn ngh·ªã: 1:1 (vu√¥ng)
                </li>
                <li className={styles.guideline}>
                  <i className="fas fa-check"></i>
                  ƒê·ªãnh d·∫°ng: JPG, PNG, GIF
                </li>
                <li className={styles.guideline}>
                  <i className="fas fa-check"></i>
                  K√≠ch th∆∞·ªõc file: T·ªëi ƒëa 5MB
                </li>
              </ul>
            </div>

            <div className={styles.formActions}>
              <button
                type="button"
                onClick={handleCancel}
                className={styles.cancelButton}
                disabled={loading}
              >
                <i className="fas fa-times"></i>
                H·ªßy
              </button>
              <button
                type="submit"
                className={styles.saveButton}
                disabled={loading || !selectedFile}
              >
                {loading ? (
                  <>
                    <i className="fas fa-spinner fa-spin"></i>
                    ƒêang c·∫≠p nh·∫≠t...
                  </>
                ) : (
                  <>
                    <i className="fas fa-save"></i>
                    C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán
                  </>
                )}
              </button>
            </div>
          </form>
        </div>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast(prev => ({ ...prev, isVisible: false }))}
      />
    </div>
  );
};

export default ChangeAvatarPage;
